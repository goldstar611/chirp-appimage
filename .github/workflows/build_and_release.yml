name: build_and_release

on:
  schedule:
    - cron: '06 11 * * *'

  workflow_dispatch:

  # Allows Dan to trigger synchronization,
  # which then triggers snaps to build
  repository_dispatch:
    types: dan-says-build

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Set Timezone
        run: |
          # Set timezone to America/Los_Angeles so the build date is aligned with official builds
          sudo sudo ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y git python3-pip patchelf fakeroot gettext lynx
          sudo -H pip3 install pyopenssl --upgrade
          sudo -H pip3 install git+https://github.com/AppImageCrafters/appimage-builder.git
          arch=$(uname -m)
          sudo wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-${arch}.AppImage -O /usr/bin/appimagetool
          sudo chmod +x /usr/bin/appimagetool

      - name: Check if Release Exists
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ -z "${GITHUB_WORKSPACE}" ]]; then
            # Use curl if not github.com actions not detected
            ver_with_next=$(basename $(curl -L -s -o /dev/null -w '%{url_effective}' "https://archive.chirpmyradio.com/download?stream=next"))
          else
            # If github.com actions is detected, use the scriptable console-based lynx browser
            ver_with_next=$(basename $(lynx -dump -noredir -head "https://archive.chirpmyradio.com/download?stream=next" | grep -E -o 'https://.*chirp.*$'))
          fi

          # Save $ver_with_next for the Release job
          echo "VER_WITH_NEXT=$ver_with_next" >> $GITHUB_ENV

          # The `gh release view` command returns a non-zero exit code if the release tag does not exist.
          # Set the appropriate shell option so the script continues.
          set +e

          gh release view ${ver_with_next}
          if [ $? -eq 0 ]; then
            echo "Release exists, exiting."
            exit 0
          fi

      - name: Build AppImage
        run: |
          chmod +x ./build.sh
          ./build.sh

      - name: Release
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          artifacts=Chirp-*.AppImage
          tag="${{ env.VER_WITH_NEXT }}"

          gh release create --latest ${tag} -t ${tag} ${artifacts} --notes ""
          gh release upload ${tag} ${artifacts}
